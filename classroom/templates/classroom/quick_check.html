{% extends 'base.html' %}
{% load i18n %}
{% block content %}

<div class="checkup-container d-flex align-items-center justify-content-center py-5">
  <div class="checkup-card container p-4 p-md-5 rounded-4 shadow-lg bg-white animate-fade-in">
    
    <!-- ğŸ©º Header -->
    <div class="text-center mb-4">
      <h2 class="fw-bold text-gradient">ğŸ©º {% trans "Quick Health Check" %}</h2>
      <p class="text-muted mb-1">{{ vc }} â€” {% trans "Student" %} {{ idx|add:1 }} {% trans "of" %} {{ total }}</p>
    </div>

    <!-- ğŸ‘©â€ğŸ“ Student Info -->
    <div class="text-center mb-4">
      <h4 class="fw-semibold text-dark mb-0">{{ student.user.get_full_name }}</h4>
      <small class="text-muted">{% trans "Roll No" %}: {{ student.roll_no }}</small>
    </div>

    <!-- ğŸ§¾ Form -->
    <form method="post" class="row g-3">
      {% csrf_token %}
      <input type="hidden" name="idx" value="{{ idx }}">
      <div class="col-md-6">
        <label class="form-label fw-semibold">ğŸ’“ {% trans "Heart Rate (bpm)" %}</label>
        <input type="number" name="heart_rate" class="form-control form-control-lg" required>
      </div>
      <div class="col-md-6">
        <label class="form-label fw-semibold">ğŸ« {% trans "SpOâ‚‚ (%)" %}</label>
        <input type="number" step="0.1" name="spo2" class="form-control form-control-lg" required>
      </div>
      <div class="col-md-6">
        <label class="form-label fw-semibold">ğŸŒ¬ï¸ {% trans "Breathing Rate" %}</label>
        <input type="number" step="0.1" name="breathing_rate" class="form-control form-control-lg" required>
      </div>
      <div class="col-md-6">
        <label class="form-label fw-semibold">ğŸŒ¡ï¸ {% trans "Temperature (Â°C)" %}</label>
        <input type="number" step="0.1" name="temperature" class="form-control form-control-lg" required>
      </div>
      <div class="col-md-6">
        <label class="form-label fw-semibold">ğŸ“ {% trans "Height (cm)" %}</label>
        <input type="number" step="0.1" name="height_cm" class="form-control form-control-lg" value="{{ student.height_cm }}">
      </div>
      <div class="col-md-6">
        <label class="form-label fw-semibold">âš–ï¸ {% trans "Weight (kg)" %}</label>
        <input type="number" step="0.1" name="weight_kg" class="form-control form-control-lg" value="{{ student.weight_kg }}">
      </div>

      <div class="d-flex justify-content-between mt-4">
        <a href="{% url 'classroom_detail' vc.id %}" class="btn btn-outline-secondary rounded-pill px-4 py-2 shadow-sm">
          â† {% trans "Back" %}
        </a>
        <button type="submit" class="btn btn-success rounded-pill px-4 py-2 shadow-sm">
          {% trans "Save & Check" %} â†’
        </button>
      </div>
    </form>
  </div>
</div>

<!-- âœ… Animated Health Result Modal -->
{% if prediction_label %}
<div class="modal fade show result-modal"
     id="resultModal"
     tabindex="-1"
     style="display:block; background:rgba(0,0,0,0.6);"
     aria-modal="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content text-center p-4 rounded-4 shadow-lg glow-{{ prediction_label|lower }}">
      <div class="modal-body">
        {% if "healthy" in prediction_label|lower %}
          <div class="emoji-bounce" style="font-size:4rem;">ğŸ˜„</div>
        {% elif "mild" in prediction_label|lower or "moderate" in prediction_label|lower %}
          <div class="emoji-bounce" style="font-size:4rem;">ğŸ˜</div>
        {% else %}
          <div class="emoji-bounce" style="font-size:4rem;">ğŸ˜Ÿ</div>
        {% endif %}

        <h3 class="fw-bold mt-3">{{ prediction_label }}</h3>
        <p class="text-muted mb-4">{% trans "Prediction Score" %}: <strong>{{ prediction_score }}</strong></p>

        <div class="d-flex justify-content-center gap-3">
          <!-- âœ… NEXT STUDENT BUTTON -->
          <a href="?idx={{ idx|add:1 }}" class="btn btn-success rounded-pill px-4 shadow-sm">
            ğŸ§‘â€ğŸ“ {% trans "Next Student" %} â†’
          </a>

          <!-- âœ… SEND ALERT BUTTON -->
          {% if "mild" in prediction_label|lower or "moderate" in prediction_label|lower or "critical" in prediction_label|lower or "high" in prediction_label|lower %}
          <form method="post" style="display:inline;">
            {% csrf_token %}
            <input type="hidden" name="alert" value="1">
            <button type="submit" class="btn btn-danger rounded-pill px-4 shadow-sm">
              ğŸ“§ {% trans "Send Alert" %}
            </button>
          </form>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>
{% endif %}

<!-- âš ï¸ Invalid Email Alert Modal -->
{% if invalid_email %}
<div class="modal fade show result-modal"
     id="invalidEmailModal"
     tabindex="-1"
     style="display:block; background:rgba(0,0,0,0.6);"
     aria-modal="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content text-center p-4 rounded-4 shadow-lg border-3 border-warning">
      <div class="modal-body">
        <div style="font-size:4rem;" class="emoji-bounce">âš ï¸</div>
        <h4 class="fw-bold text-warning mt-3">{% trans "Invalid Parent Email" %}</h4>
        <p class="text-muted">{% trans "The registered parent email is invalid or missing." %}<br>
          {% trans "Please update it before sending alerts." %}</p>
        <div class="mt-3">
          <a href="?idx={{ idx|add:1 }}" class="btn btn-success rounded-pill px-4 py-2 shadow-sm">{% trans "Next Student" %} â†’</a>
        </div>
      </div>
    </div>
  </div>
</div>
{% endif %}

<!-- ğŸŒˆ Styling -->
<style>
.checkup-container {
  min-height: calc(100vh - 100px);
  background: linear-gradient(-45deg, #007bff, #00c6ff, #17a2b8, #6f42c1);
  background-size: 400% 400%;
  animation: gradientShift 15s ease infinite;
}

.text-gradient {
  background: linear-gradient(90deg, #007bff, #00c6ff);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

/* ğŸ”¥ Modal Styling with Glow Colors */
.modal-content {
  animation: popIn 0.5s ease;
  border: none;
}
.glow-healthy {
  box-shadow: 0 0 30px 5px rgba(40, 167, 69, 0.6);
  border-top: 5px solid #28a745;
}
.glow-mild, .glow-moderate {
  box-shadow: 0 0 30px 5px rgba(255, 193, 7, 0.6);
  border-top: 5px solid #ffc107;
}
.glow-critical, .glow-high {
  box-shadow: 0 0 30px 5px rgba(220, 53, 69, 0.7);
  border-top: 5px solid #dc3545;
}

/* ğŸ¬ Animations */
@keyframes popIn {
  from { transform: scale(0.85); opacity: 0; }
  to { transform: scale(1); opacity: 1; }
}
@keyframes bounce {
  0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
  40% { transform: translateY(-20px); }
  60% { transform: translateY(-10px); }
}
.emoji-bounce {
  animation: bounce 1.2s ease infinite;
}

/* ğŸŒ€ Background gradient animation */
@keyframes gradientShift {
  0% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
  100% { background-position: 0% 50%; }
}
</style>

{% endblock %}